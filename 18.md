# NIP-18

## Private Direct Message

`draft` `optional` `author:giszmo`

A special event with `kind: 4`, meaning "private direct message". It improves on
[nip-04](04.md) by not revealing the recipient of direct messages. The event
format is equal to nip-04, with the following changes:

**`tags`** MAY contain entries identifying potential recipients of the message
in the form `["p", "<pubkey>"]`.

**`tags`** SHOULD NOT contain further identifying information such as references
to events as described in nip-04.

**`content`** MUST be the base64-encoded, aes-256-cbc encrypted msg as in nip-4.
The plain msg MUST be prefixed with the markdown line
`[//]: # (nip18)<newline>`.

## Sending DM

The sender SHOULD add a tag identifying the recipient on the first message of a
conversation if the other party does not publicly follow them according to their
[nip-04](04.md) contact list event.

## Receiving DM

Clients should query for all potentially relevant `kind: 4` events:

* `{"kinds":[4],"#p":["<pubkey>"]:}` publicly directed at our pubkey.
* `{"kinds":[4],"authors":[<pubkeys of all follows>]}` most natural
  correspondence.
* `{"kinds":[4],"#p":["<pubkey of prior conversations>"]}`

or if possible, all `kind: 4` events.

Clients should try to decrypt all received events regardless of their receiver
tag or absence thereof. If decryption succeeds:

* If the receiver tag was set to the actual receiver, assume a nip-04 event.
* If the receiver is missing or differs from actual receiver, check for the
  presence of `[//]: # (nip18)<newline>` in the beginning of the plain content.
  * If absent, decryption has randomly "succeeded", not containing relevant
    data. The event MUST be discarded.
  * If present, this was a relevant nip-18 event and the line may be dropped.

## Privacy Analysis

### Events

Users still leak being active via attributable events but timing analysis
becomes harder as soon as several chats happen at once.

### Relays

Relays knowing who is interested in which event have an advantage at learning
who is chatting. Therefore clients should query non-follows for example using
different identities, via TOR or similar.

## Example

```
privAlice:         aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
pubAlice:          6a04ab98d9e4774ad806e302dddeb63bea16b5cb5f223ee77478e861bb583eb3
privBob:           bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
pubBob:            68680737c76dabb801cb2204f57dbe4e4579e4f710cd67dc1b4227592c81e9b5
privCarol:         cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
pubCarol:          b95c249d84f417e3e395a127425428b540671cc15881eb828c17b722a53fc599

sharedSecretAB:    1d3e7279da3f845c4246087cdd3dd42bea3dea7245ceaf75609d8eb0a4e89c4e
msg:               Hello World!
event:             {
                     "id":"7da0397db43813a70e5e13da554e0b38ba029881889b52c406f3ff63a6b1b435",
                     "pubkey":"6a04ab98d9e4774ad806e302dddeb63bea16b5cb5f223ee77478e861bb583eb3",
                     "created_at":1657639346,
                     "kind":4,
                     "tags":[[
                       "p","b95c249d84f417e3e395a127425428b540671cc15881eb828c17b722a53fc599"
                     ]],
                     "content":"w681KMgzPZFM8a3xoJpIMra5vyWaJNAmH8tPBwIN+W0=?iv=TJyNeDOAPUCGFDg821j4EQ==",
                     "sig":"9648aeb9276d3950c6fd83db0861fea370c1ffa0d7245be5cb00689093b098bf18aa4250a3b6eceda51d22b2fbee2891e5428856737263540ba1ebfd4ca12e05"
                   }
contentBobNip04:   [//]: # (nip18)
                   Hello World!
contentBobNip18:   Hello World!
contentCarol:      <error or gibberish>
```
